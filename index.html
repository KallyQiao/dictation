<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Vocabulary Dictation (中文/English)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --accent: #3b82f6;
      --bg: #f8fafc;
      --text: #0f172a;
      --muted: #475569;
      --border: #e2e8f0;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "Microsoft YaHei", "PingFang SC", sans-serif;
           background: var(--bg); color: var(--text); margin: 0; }
    header { background: white; border-bottom: 1px solid var(--border); padding: 1rem 1.25rem; }
    main { max-width: 960px; margin: 1rem auto; padding: 0 1rem; }
    h1 { margin: 0; font-size: 1.25rem; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 900px) { .grid { grid-template-columns: 2fr 1fr; } }
    section { background: white; border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; }
    label { display: block; margin-top: 0.5rem; font-weight: 600; }
    textarea { width: 100%; min-height: 220px; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; resize: vertical; }
    input[type="number"], select, input[type="file"] { width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.5rem; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .controls { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; }
    button { padding: 0.55rem 0.9rem; border: 1px solid var(--border); border-radius: 0.6rem; background: white; cursor: pointer; }
    button.primary { background: var(--accent); color: white; border-color: var(--accent); }
    button.danger { background: #ef4444; color: white; border-color: #ef4444; }
    .muted { color: var(--muted); font-size: 0.9rem; }
    .pill { display: inline-block; background: #eef2ff; color: #4338ca; padding: 0.25rem 0.5rem; border-radius: 999px; font-size: 0.8rem; }
    .dropzone { border: 2px dashed var(--border); border-radius: 0.6rem; padding: 1rem; text-align: center; color: var(--muted); }
    .progress { height: 8px; background: #e5e7eb; border-radius: 999px; overflow: hidden; }
    .bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.2s ease; }
    .small { font-size: 0.85rem; }
    .list { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
  </style>
</head>
<body>
  <header>
    <h1>Vocabulary Dictation（词汇听写）</h1>
    <div class="muted small">Type words, upload TXT/CSV, or take a photo to OCR → speak with pauses & repeats</div>
  </header>

  <main class="grid">
    <!-- Left: Word list and inputs -->
    <section>
      <label>Words / phrases（每行一个）</label>
      <textarea id="words" placeholder="Enter one word per line... e.g.&#10;apple&#10;香蕉&#10;orange&#10;词汇">apple
香蕉
orange
词汇</textarea>
      <div class="controls">
        <button id="clearBtn">Clear</button>
        <button id="dedupeBtn">Remove duplicates</button>
        <button id="shuffleBtn">Shuffle</button>
        <button id="exportBtn">Export .txt</button>
        <span class="pill"><span id="count">4</span> items</span>
      </div>

      <hr>
      <div class="row">
        <div>
          <label>Upload TXT/CSV</label>
          <input id="fileInput" type="file" accept=".txt,.csv">
          <div class="muted small">TXT: one per line; CSV: first column used</div>
        </div>
        <div>
          <label>Take photo / upload image（拍照或上传图片）</label>
          <input id="imageInput" type="file" accept="image/*" capture="environment">
          <div class="muted small">OCR language:
            <select id="ocrLang">
              <option value="eng">English (eng)</option>
              <option value="chi_sim" selected>简体中文 (chi_sim)</option>
              <option value="chi_tra">繁体中文 (chi_tra)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="dropzone" id="dropzone">Drag & drop image here for OCR（拖拽图片到此处）</div>
      <div id="ocrStatus" class="muted small"></div>
      <div class="progress" style="margin-top:0.5rem;"><div class="bar" id="ocrBar"></div></div>
      <div id="ocrPreview" class="small list" style="white-space: pre-wrap; margin-top:0.5rem;"></div>
    </section>

    <!-- Right: Dictation controls -->
    <section>
      <label>Language per word（语言选择）</label>
      <select id="lang">
        <option value="auto" selected>Auto detect (中文→zh-CN; else en-US)</option>
        <option value="en-US">English (en-US)</option>
        <option value="zh-CN">中文（普通话 zh-CN）</option>
      </select>

      <label>Voice（声线）</label>
      <select id="voice"><option value="">(auto choose)</option></select>
      <div class="muted small">Tip: Install system voices for better Chinese/English quality (Windows: Language & Region; macOS: Accessibility → Spoken Content).</div>

      <div class="row">
        <div>
          <label>Pause between words (seconds)</label>
          <input id="pause" type="number" value="3" min="0" step="0.5">
        </div>
        <div>
          <label>Repeat each word</label>
          <input id="repeat" type="number" value="1" min="1">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Speech rate（语速 0.5–2.0）</label>
          <input id="rate" type="number" value="1.0" min="0.5" max="2" step="0.1">
        </div>
        <div>
          <label>Volume（音量 0.0–1.0）</label>
          <input id="volume" type="number" value="1.0" min="0" max="1" step="0.1">
        </div>
      </div>

      <div class="controls">
        <button id="startBtn" class="primary">Start Dictation</button>
        <button id="stopBtn" class="danger">Stop</button>
      </div>

      <div id="status" class="muted small" style="margin-top:0.5rem;"></div>
    </section>
  </main>

  <!-- Tesseract.js (client-side OCR). If CDN is blocked, host locally and change src to ./tesseract.min.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>

  <script>
    /*** ---------- Voice setup (Web Speech API) ---------- ***/
    let voices = [];
    const voiceSelect = document.getElementById('voice');

    function populateVoices() {
      voices = window.speechSynthesis.getVoices();
      voiceSelect.innerHTML = '<option value="">(auto choose)</option>';
      voices.forEach((v, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = `${v.name} — ${v.lang}`;
        voiceSelect.appendChild(opt);
      });
    }
    populateVoices();
    window.speechSynthesis.onvoiceschanged = populateVoices;

    function detectLang(text) {
      return Array.from(text).some(ch => ch >= '\u4e00' && ch <= '\u9fff') ? 'zh-CN' : 'en-US';
    }
    function chooseVoice(lang, explicitIndex) {
      if (explicitIndex !== "") {
        return voices[Number(explicitIndex)] || null;
      }
      const exact = voices.find(v => v.lang === lang);
      if (exact) return exact;
      const family = voices.find(v => v.lang && v.lang.startsWith(lang.split('-')[0]));
      return family || null;
    }

    async function speakWord(text, lang, voice, rate, volume) {
      return new Promise((resolve, reject) => {
        const utter = new SpeechSynthesisUtterance(text);
        if (voice) utter.voice = voice;
        utter.lang = lang;
        utter.rate = rate;
        utter.volume = volume;
        utter.onend = () => resolve();
        utter.onerror = e => reject(e);
        window.speechSynthesis.speak(utter);
      });
    }

    /*** ---------- Dictation flow ---------- ***/
    let cancelRequested = false;
    const $ = id => document.getElementById(id);

    function getLines() {
      const lines = $('words').value.split('\n').map(s => s.trim()).filter(Boolean);
      $('count').textContent = lines.length;
      return lines;
    }

    async function startDictation() {
      cancelRequested = false;
      $('status').textContent = 'Speaking...';
      const lines = getLines();
      const pauseSec = Number($('pause').value) || 3;
      const repeat = Number($('repeat').value) || 1;
      const langSetting = $('lang').value;
      const voiceIndex = $('voice').value;
      const rate = Math.max(0.5, Math.min(2.0, Number($('rate').value) || 1.0));
      const volume = Math.max(0, Math.min(1.0, Number($('volume').value) || 1.0));

      for (const word of lines) {
        if (cancelRequested) break;
        const lang = langSetting === 'auto' ? detectLang(word) : langSetting;
        const voice = chooseVoice(lang, voiceIndex);
        for (let i = 0; i < repeat; i++) {
          if (cancelRequested) break;
          try { await speakWord(word, lang, voice, rate, volume); } catch (err) { console.error(err); }
          await new Promise(r => setTimeout(r, pauseSec * 1000));
        }
      }
      $('status').textContent = cancelRequested ? 'Stopped.' : 'Done.';
    }

    $('startBtn').onclick = startDictation;
    $('stopBtn').onclick = () => { cancelRequested = true; window.speechSynthesis.cancel(); $('status').textContent = 'Stopped.'; };

    $('clearBtn').onclick = () => { $('words').value = ''; $('count').textContent = '0'; };
    $('dedupeBtn').onclick = () => {
      const set = new Set(getLines());
      $('words').value = [...set].join('\n');
      $('count').textContent = set.size;
    };
    $('shuffleBtn').onclick = () => {
      const arr = getLines();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      $('words').value = arr.join('\n');
      $('count').textContent = arr.length;
    };
    $('exportBtn').onclick = () => {
      const blob = new Blob([$('words').value], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'words.txt'; a.click();
      URL.revokeObjectURL(url);
    };

    /*** ---------- TXT/CSV upload ---------- ***/
    $('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      let lines = [];
      if (file.name.toLowerCase().endsWith('.csv')) {
        lines = text.split('\n').map(row => (row.split(',')[0] || '').trim()).filter(Boolean);
      } else {
        lines = text.split('\n').map(s => s.trim()).filter(Boolean);
      }
      const current = getLines();
      $('words').value = [...current, ...lines].join('\n');
      $('count').textContent = getLines().length;
      e.target.value = '';
    });

    /*** ---------- OCR (Tesseract.js) ---------- ***/
    const dropzone = $('dropzone');
    dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.style.borderColor = '#93c5fd'; });
    dropzone.addEventListener('dragleave', () => { dropzone.style.borderColor = 'var(--border)'; });
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault(); dropzone.style.borderColor = 'var(--border)';
      if (e.dataTransfer.files?.[0]) runOCR(e.dataTransfer.files[0]);
    });

    $('imageInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      runOCR(file);
      e.target.value = '';
    });

    async function runOCR(file) {
      $('ocrStatus').textContent = 'Running OCR...';
      $('ocrBar').style.width = '0%';
      const lang = $('ocrLang').value;
      try {
        const { data } = await Tesseract.recognize(file, lang, {
          logger: m => {
            if (m.status === 'recognizing text' && m.progress != null) {
              $('ocrBar').style.width = (m.progress * 100).toFixed(0) + '%';
            }
          }
        });
        $('ocrPreview').textContent = (data.text || '').trim();
        const extracted = postProcessOCR(data.text || '');
        const current = getLines();
        $('words').value = [...current, ...extracted].join('\n');
        $('count').textContent = getLines().length;
        $('ocrStatus').textContent = `OCR complete: added ${extracted.length} items.`;
      } catch (err) {
        console.error(err);
        $('ocrStatus').textContent = 'OCR error. Try a clearer photo or different language.';
      }
    }

    function postProcessOCR(text) {
      let t = text.replace(/\r/g, '\n');
      t = t.replace(/[，、；。]/g, '\n'); // Chinese punctuations → newline
      t = t.replace(/[;,]/g, '\n');     // English punctuations → newline
      const tokens = t.split('\n')
        .map(s => s.trim())
        .filter(Boolean)
        .map(s => s.replace(/\s+/g, ' '));
      const out = [];
      const seen = new Set();
      for (const tok of tokens) {
        const isChinese = Array.from(tok).some(ch => ch >= '\u4e00' && ch <= '\u9fff');
        if (tok.length < 2 && !isChinese) continue;
        if (!seen.has(tok)) { seen.add(tok); out.push(tok); }
      }
      return out;
    }
  </script>
</body>
</html>