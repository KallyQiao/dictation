<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>词汇听写（Vocabulary Dictation）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --accent:#3b82f6; --bg:#f8fafc; --text:#0f172a; --muted:#475569; --border:#e2e8f0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Microsoft YaHei", "PingFang SC", sans-serif; background:var(--bg); color:var(--text); margin:0; }
    header { background:white; border-bottom:1px solid var(--border); padding:1rem 1.25rem; }
    main { max-width:960px; margin:1rem auto; padding:0 1rem; }
    h1 { margin:0; font-size:1.25rem; }
    .grid { display:grid; grid-template-columns:1fr; gap:1rem; }
    @media (min-width:900px){ .grid { grid-template-columns:2fr 1fr; } }
    section { background:white; border:1px solid var(--border); border-radius:0.75rem; padding:1rem; }
    label { display:block; margin-top:0.5rem; font-weight:600; }
    textarea { width:100%; min-height:220px; padding:0.75rem; border:1px solid var(--border); border-radius:0.5rem; resize:vertical; }
    input[type="number"], select, input[type="file"] { width:100%; padding:0.5rem; border:1px solid var(--border); border-radius:0.5rem; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:0.75rem; }
    .controls { display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.75rem; }
    button { padding:0.55rem 0.9rem; border:1px solid var(--border); border-radius:0.6rem; background:white; cursor:pointer; }
    button.primary { background:var(--accent); color:white; border-color:var(--accent); }
    button.danger { background:#ef4444; color:white; border-color:#ef4444; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .pill { display:inline-block; background:#eef2ff; color:#4338ca; padding:0.25rem 0.5rem; border-radius:999px; font-size:0.8rem; }
    .dropzone { border:2px dashed var(--border); border-radius:0.6rem; padding:1rem; text-align:center; color:var(--muted); }
    .progress { height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .bar { height:100%; width:0%; background:var(--accent); transition:width 0.2s ease; }
    .small { font-size:0.85rem; }
    .list { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
  </style>
</head>
<body>
  <header>
    <h1>词汇听写（Vocabulary Dictation）</h1>
    <div class="muted small">支持手动输入 / TXT/CSV 上传 / 图片OCR；每次朗读一个词，可配置停顿与重复。</div>
  </header>

  <main class="grid">
    <!-- 左侧：词列表与输入 -->
    <section>
      <label>词/短语（每行一个）</label>
      <textarea id="words" placeholder="每行一个，例如：\napple\n香蕉\norange\n词汇">apple
香蕉
orange
词汇</textarea>
      <div class="controls">
        <button id="clearBtn">清空</button>
        <button id="dedupeBtn">去重</button>
        <button id="shuffleBtn">打乱顺序</button>
        <button id="exportBtn">导出 .txt</button>
        <span class="pill"><span id="count">4</span> 条</span>
      </div>

      <hr>
      <div class="row">
        <div>
          <label>上传 TXT/CSV</label>
          <input id="fileInput" type="file" accept=".txt,.csv">
          <div class="muted small">TXT：每行一个；CSV：使用第一列</div>
        </div>
        <div>
          <label>拍照/上传图片（OCR）</label>
          <input id="imageInput" type="file" accept="image/*" capture="environment">
          <div class="muted small">OCR 语言：
            <select id="ocrLang">
              <option value="eng">English (eng)</option>
              <option value="chi_sim" selected>简体中文 (chi_sim)</option>
              <option value="chi_tra">繁体中文 (chi_tra)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="dropzone" id="dropzone">将图片拖到此处进行 OCR</div>
      <div id="ocrStatus" class="muted small"></div>
      <div class="progress" style="margin-top:0.5rem;"><div class="bar" id="ocrBar"></div></div>
      <div id="ocrPreview" class="small list" style="white-space: pre-wrap; margin-top:0.5rem;"></div>
    </section>

    <!-- 右侧：朗读控制 -->
    <section>
      <label>语言选择（每词）</label>
      <select id="lang">
        <option value="auto" selected>自动（含中文→zh-CN，否则 en-US）</option>
        <option value="en-US">仅英语（en-US）</option>
        <option value="zh-CN">仅中文（zh-CN）</option>
      </select>

      <label>声线（Voice）</label>
      <select id="voice"><option value="">（自动选择）</option></select>
      <div class="muted small">如中文/英文声音不理想，安装系统语音包后重启浏览器。</div>

      <div class="row">
        <div>
          <label>每词停顿（秒）</label>
          <input id="pause" type="number" value="3" min="0" step="0.5">
        </div>
        <div>
          <label>重复次数</label>
          <input id="repeat" type="number" value="1" min="1">
        </div>
      </div>

      <div class="row">
        <div>
          <label>语速（0.5–2.0）</label>
          <input id="rate" type="number" value="1.0" min="0.5" max="2" step="0.1">
        </div>
        <div>
          <label>音量（0.0–1.0）</label>
          <input id="volume" type="number" value="1.0" min="0" max="1" step="0.1">
        </div>
      </div>

      <div class="controls">
        <button id="speakCurrentBtn" class="primary">朗读当前行</button>
        <button id="startBtn">按列表逐个朗读</button>
        <button id="stopBtn" class="danger">停止</button>
      </div>

      <div id="status" class="muted small" style="margin-top:0.5rem;"></div>
    </section>
  </main>

  <!-- Tesseract.js：如 CDN 受限，可改为本地 ./tesseract.min.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>

  <script>
    /*** ------------ 工具 & 计数 ------------ ***/
    const $ = id => document.getElementById(id);
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    function updateCount(){
      const lines = $('words').value.split('\n').map(s=>s.trim()).filter(Boolean);
      $('count').textContent = lines.length;
    }
    $('words').addEventListener('input', updateCount);

    /*** ------------ 语音（Web Speech API） ------------ ***/
    let voices = []; let voicesReady = false; const voiceSelect = $('voice');
    function populateVoices(){
      voices = window.speechSynthesis.getVoices();
      if(!voices || !voices.length) return;
      voicesReady = true;
      voiceSelect.innerHTML = '<option value="">（自动选择）</option>';
      voices.forEach((v, idx)=>{
        const opt = document.createElement('option');
        opt.value = idx; opt.textContent = `${v.name} — ${v.lang}`; voiceSelect.appendChild(opt);
      });
    }
    populateVoices(); window.speechSynthesis.onvoiceschanged = populateVoices;
    async function ensureVoicesReady(){ for(let i=0;i<20 && !voicesReady;i++){ await sleep(100); populateVoices(); } }
    function detectLang(text){ return Array.from(text).some(ch=>ch>='\u4e00' && ch<='\u9fff') ? 'zh-CN' : 'en-US'; }
    function chooseVoice(lang, explicitIndex){ if(explicitIndex !== '') return voices[Number(explicitIndex)]||null; const exact = voices.find(v=>v.lang===lang); if(exact) return exact; const family = voices.find(v=>v.lang && v.lang.startsWith(lang.split('-')[0])); return family || null; }
    async function speakWord(text, lang, voice, rate, volume){
      window.speechSynthesis.cancel(); await sleep(150); await ensureVoicesReady();
      return new Promise((resolve, reject)=>{
        const utter = new SpeechSynthesisUtterance(text);
        if(voice) utter.voice = voice; utter.lang = lang; utter.rate = rate; utter.volume = volume;
        utter.onend = ()=>resolve(); utter.onerror = e=>{ console.error(e); reject(e); };
        window.speechSynthesis.speak(utter);
      });
    }

    /*** ------------ 当前行 & 列表朗读 ------------ ***/
    function getLines(){ return $('words').value.split('\n').map(s=>s.trim()).filter(Boolean); }
    function getCurrentLineText(){ const ta=$('words'); const value=ta.value; const pos=ta.selectionStart||0; const start=value.lastIndexOf('\n', Math.max(0,pos-1))+1; const endIdx=value.indexOf('\n', pos); const end=endIdx===-1?value.length:endIdx; return value.slice(start,end).trim(); }
    let cancelRequested=false; let speaking=false;
    async function speakOne(text){ if(!text){ $('status').textContent='当前行为空'; return; }
      speaking=true; $('status').textContent=`朗读：${text}`;
      const langSetting=$('lang').value; const voiceIndex=$('voice').value;
      const rate=Math.max(0.5, Math.min(2.0, Number($('rate').value)||1.0));
      const volume=Math.max(0, Math.min(1.0, Number($('volume').value)||1.0));
      const repeat=Math.max(1, Number($('repeat').value)||1); const pauseSec=Math.max(0, Number($('pause').value)||0);
      const lang = langSetting==='auto' ? detectLang(text) : langSetting; const voice = chooseVoice(lang, voiceIndex);
      for(let i=0;i<repeat;i++){ if(cancelRequested) break; try{ await speakWord(text, lang, voice, rate, volume);}catch(e){} if(i<repeat-1) await sleep(pauseSec*1000); }
      speaking=false; $('status').textContent = cancelRequested?'已停止':'完成'; }
    async function startDictationSequential(){ if(speaking) return; cancelRequested=false; $('startBtn').disabled=true; $('speakCurrentBtn').disabled=true; $('status').textContent='开始逐个朗读…';
      const lines=getLines(); const pauseSec=Math.max(0, Number($('pause').value)||0); const repeat=Math.max(1, Number($('repeat').value)||1);
      const langSetting=$('lang').value; const voiceIndex=$('voice').value; const rate=Math.max(0.5, Math.min(2.0, Number($('rate').value)||1.0)); const volume=Math.max(0, Math.min(1.0, Number($('volume').value)||1.0));
      for(const word of lines){ if(cancelRequested) break; const lang=langSetting==='auto'?detectLang(word):langSetting; const voice=chooseVoice(lang, voiceIndex);
        for(let i=0;i<repeat;i++){ if(cancelRequested) break; try{ await speakWord(word, lang, voice, rate, volume);}catch(e){} if(i<repeat-1) await sleep(pauseSec*1000); }
        await sleep(pauseSec*1000);
      }
      $('startBtn').disabled=false; $('speakCurrentBtn').disabled=false; $('status').textContent = cancelRequested?'已停止':'完成'; }
    $('speakCurrentBtn').onclick = async ()=>{ cancelRequested=false; const line=getCurrentLineText(); await speakOne(line); };
    $('startBtn').onclick = startDictationSequential;
    $('stopBtn').onclick = async ()=>{ cancelRequested=true; window.speechSynthesis.cancel(); await sleep(150); $('status').textContent='已停止'; speaking=false; $('startBtn').disabled=false; $('speakCurrentBtn').disabled=false; };

    /*** ------------ TXT/CSV 上传 ------------ ***/
    $('fileInput').addEventListener('change', async (e)=>{
      const file=e.target.files[0]; if(!file) return; const text=await file.text(); let lines=[];
      if(file.name.toLowerCase().endsWith('.csv')){ lines = text.split('\n').map(row=>(row.split(',')[0]||'').trim()).filter(Boolean); }
      else { lines = text.split('\n').map(s=>s.trim()).filter(Boolean); }
      const current=getLines(); const merged=[...current, ...lines]; const deduped=Array.from(new Set(merged));
      $('words').value = deduped.join('\n'); $('words').dispatchEvent(new Event('input')); e.target.value='';
    });

    /*** ------------ OCR（Tesseract.js） ------------ ***/
    const dropzone=$('dropzone');
    dropzone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropzone.style.borderColor='#93c5fd'; });
    dropzone.addEventListener('dragleave', ()=>{ dropzone.style.borderColor='var(--border)'; });
    dropzone.addEventListener('drop', (e)=>{ e.preventDefault(); dropzone.style.borderColor='var(--border)'; const file=e.dataTransfer.files?.[0]; if(file) runOCR(file); });
    $('imageInput').addEventListener('change', (e)=>{ const file=e.target.files[0]; if(!file) return; runOCR(file); e.target.value=''; });

    function previewImage(file){ try{ const url=URL.createObjectURL(file); $('ocrPreview').innerHTML = `<div class="muted small">图片预览：</div><img src="${url}" style="max-width:100%; border:1px solid #eee; border-radius:6px; margin:.5rem 0;" />`; setTimeout(()=>URL.revokeObjectURL(url), 60000);}catch{} }

    async function runOCR(file){
      previewImage(file);
      $('ocrStatus').textContent='OCR 处理中…'; $('ocrBar').style.width='0%'; const lang=$('ocrLang').value;
      try{
        const { data } = await Tesseract.recognize(file, lang, { logger: m=>{ if(m.status==='recognizing text' && m.progress!=null){ $('ocrBar').style.width=(m.progress*100).toFixed(0)+'%'; } } });
        const raw=(data.text||'').trim(); if(!raw){ $('ocrStatus').textContent='未识别到文字，请换更清晰的图片或切换 OCR 语言。'; return; }
        $('ocrPreview').textContent = raw; // 展示原始结果
        const extracted = robustSplitAndClean(raw);
        if(!extracted.length){ $('ocrStatus').textContent='识别成功但未提取到有效词条，请检查分隔符或内容。'; return; }
        const current=getLines(); const merged=[...current, ...extracted]; const deduped=Array.from(new Set(merged));
        $('words').value = deduped.join('\n'); $('words').dispatchEvent(new Event('input'));
        $('ocrStatus').textContent = `OCR 完成：新增 ${deduped.length - current.length} 条。`;
      }catch(err){ console.error(err); $('ocrStatus').textContent='OCR 出错：请重试或更换语言/更清晰图片。'; }
    }

    function robustSplitAndClean(text){
      let t = text.replace(/\r/g, '\n');
      t = t.replace(/[，、；。？！：]/g, '\n'); // 中文标点
      t = t.replace(/[;,!?:]/g, '\n');      // 英文标点
      let tokens = t.includes('\n') ? t.split('\n') : t.split(/\s+/);
      tokens = tokens.map(s=>s.trim()).filter(Boolean).map(s=>s.replace(/\s+/g, ' '));
      const out=[]; const seen=new Set();
      for(const tok of tokens){ const isZh = Array.from(tok).some(ch=>ch>='\u4e00' && ch<='\u9fff'); if(tok.length<2 && !isZh) continue; if(!seen.has(tok)){ seen.add(tok); out.push(tok); } }
      return out;
    }

    /*** ------------ 其它按钮 ------------ ***/
    $('clearBtn').onclick = ()=>{ $('words').value=''; $('words').dispatchEvent(new Event('input')); };
    $('dedupeBtn').onclick = ()=>{ const set=new Set(getLines()); $('words').value=[...set].join('\n'); $('words').dispatchEvent(new Event('input')); };
    $('shuffleBtn').onclick = ()=>{ const arr=getLines(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } $('words').value=arr.join('\n'); $('words').dispatchEvent(new Event('input')); };
    $('exportBtn').onclick = ()=>{ const blob=new Blob([$('words').value], {type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='words.txt'; a.click(); URL.revokeObjectURL(url); };

    // 初始化计数
    updateCount();
  </script>
</body>
</html>